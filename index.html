<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>晓南二街21-24号 - 外部电梯结构深度复原</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: 'SimHei', sans-serif; }
        
        /* UI Panel */
        #ui-panel {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            background: rgba(15, 23, 42, 0.9); padding: 20px; border-radius: 12px;
            border-left: 5px solid #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            color: #e2e8f0; pointer-events: auto; max-width: 320px;
        }
        h1 { margin: 0 0 10px 0; font-size: 18px; color: #fff; letter-spacing: 1px; }
        .desc { font-size: 13px; color: #cbd5e1; line-height: 1.6; margin-bottom: 15px; }
        
        /* Interactive Toggles */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        .toggle-label { display: flex; align-items: center; }
        .color-box { width: 12px; height: 12px; margin-right: 8px; border-radius: 3px; }
        
        /* Custom Switch */
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 18px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(16px); }

        /* Hints */
        #hint-layer {
            position: absolute; bottom: 30px; right: 30px; text-align: right;
            color: #94a3b8; font-size: 12px; pointer-events: none;
        }

        /* 3D Labels */
        .label-tag {
            background: rgba(0, 0, 0, 0.7); color: #fff; padding: 4px 8px;
            border-radius: 4px; font-size: 11px; font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.2);
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
    </style>
    <!-- Three.js Import -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui-panel">
        <h1>精细化结构复原</h1>
        <div class="desc">
            <strong>关键修正：</strong><br>
            1. 电梯井道完全位于建筑凹槽<strong>外部</strong>。<br>
            2. 1-3层仅有一部共用楼梯(22/24侧)。<br>
            3. 3-9层各楼栋有独立内部楼梯。
        </div>
        
        <div style="border-top: 1px solid #334155; padding-top: 10px;">
            <div class="toggle-row">
                <div class="toggle-label"><div class="color-box" style="background:#ef4444"></div>1-3层共用楼梯</div>
                <label class="switch"><input type="checkbox" checked onchange="toggleLayer('publicStair')"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <div class="toggle-label"><div class="color-box" style="background:#f59e0b"></div>3-9层内部楼梯</div>
                <label class="switch"><input type="checkbox" checked onchange="toggleLayer('privateStair')"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <div class="toggle-label"><div class="color-box" style="background:#3b82f6"></div>外部电梯 & 连廊</div>
                <label class="switch"><input type="checkbox" checked onchange="toggleLayer('elevator')"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
                <div class="toggle-label"><div class="color-box" style="background:#64748b"></div>建筑外墙透明度</div>
                <label class="switch"><input type="checkbox" id="transparencyToggle" onchange="toggleTransparency()"><span class="slider"></span></label>
            </div>
        </div>
    </div>

    <div id="hint-layer">
        <div style="margin-bottom:5px;">左键旋转 · 右键平移 · 滚轮缩放</div>
        <div><span style="color:#ef4444">红色</span> = 楼梯通道 | <span style="color:#3b82f6">蓝色</span> = 新增电梯</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        // --- Config ---
        const C = {
            podiumH: 10,   // 1-2F Height
            towerH: 21,    // 3-9F Height (7 floors * 3m)
            wingW: 10,     // Width of one wing
            wingD: 8,      // Depth of one wing
            gap: 8,        // The recess gap (Butterfly shape depth)
            coreW: 6       // Central connection width
        };

        // Layers Group
        const groups = {
            publicStair: new THREE.Group(),
            privateStair: new THREE.Group(),
            elevator: new THREE.Group(),
            building: new THREE.Group()
        };

        // --- Scene ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);
        
        // Grid
        const grid = new THREE.GridHelper(100, 50, 0x1e293b, 0x0f172a);
        scene.add(grid);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(70, 60, 90); // Isometric view

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const labelRenderer = new CSS2DRenderer();
        labelRenderer.setSize(window.innerWidth, window.innerHeight);
        labelRenderer.domElement.style.position = 'absolute';
        labelRenderer.domElement.style.top = '0px';
        labelRenderer.domElement.style.pointerEvents = 'none';
        document.body.appendChild(labelRenderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // Lights
        const sun = new THREE.DirectionalLight(0xffffff, 1.2);
        sun.position.set(50, 80, 50);
        sun.castShadow = true;
        scene.add(sun);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // Materials
        const matWall = new THREE.MeshLambertMaterial({ color: 0x94a3b8, transparent: true, opacity: 0.9, side: THREE.DoubleSide });
        const matFloor = new THREE.MeshLambertMaterial({ color: 0xcbd5e1 });
        const matStairPublic = new THREE.LineBasicMaterial({ color: 0xef4444, linewidth: 2 });
        const matStairPrivate = new THREE.LineBasicMaterial({ color: 0xf59e0b, linewidth: 1 });
        const matElevator = new THREE.MeshPhysicalMaterial({ color: 0x3b82f6, metalness: 0.1, roughness: 0.1, transparent: true, opacity: 0.5 });
        const matCorridor = new THREE.MeshLambertMaterial({ color: 0x60a5fa });

        // --- Builders ---

        // 1. Building Structure (Butterfly / H-Shape)
        function buildBuilding() {
            // Podium (1-2F) - Solid Base
            const pW = (C.wingW * 2) + C.coreW;
            const pD = (C.wingD * 2) + C.gap;
            const podium = new THREE.Mesh(new THREE.BoxGeometry(pW, C.podiumH, pD), matWall);
            podium.position.y = C.podiumH/2;
            groups.building.add(podium);

            // Towers (3-9F) - 4 Wings
            // 21(TL), 22(TR), 23(BL), 24(BR)
            const wings = [
                { id: "21", x: -(C.coreW/2 + C.wingW/2), z: -(C.gap/2 + C.wingD/2) },
                { id: "22", x: (C.coreW/2 + C.wingW/2), z: -(C.gap/2 + C.wingD/2) },
                { id: "23", x: -(C.coreW/2 + C.wingW/2), z: (C.gap/2 + C.wingD/2) },
                { id: "24", x: (C.coreW/2 + C.wingW/2), z: (C.gap/2 + C.wingD/2) }
            ];

            wings.forEach(w => {
                const geo = new THREE.BoxGeometry(C.wingW, C.towerH, C.wingD);
                const mesh = new THREE.Mesh(geo, matWall);
                mesh.position.set(w.x, C.podiumH + C.towerH/2, w.z);
                groups.building.add(mesh);
                
                // Edges
                const edges = new THREE.LineSegments(new THREE.EdgesGeometry(geo), new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.2 }));
                mesh.add(edges);

                addLabel(`${w.id}号楼`, w.x, C.podiumH + C.towerH + 2, w.z);
                
                // Add Private Stairs inside each wing (3-9F)
                buildStaircase(w.x, w.z, C.podiumH, C.towerH, groups.privateStair, false);
            });

            // Central Core (Connecting wings on 3-9F)
            const coreH = C.towerH;
            const coreGeo = new THREE.BoxGeometry(C.coreW, coreH, C.gap + C.wingD); 
            // Simplified connection block
            const core = new THREE.Mesh(coreGeo, matWall);
            core.position.set(0, C.podiumH + coreH/2, 0);
            groups.building.add(core);
        }

        // 2. The Public Stair (1-3F) - CRITICAL
        // Position: Right side (Positive X), between 22 and 24 (Z=0)
        function buildPublicStair() {
            const x = (C.coreW/2 + C.wingW/2); // Aligned with right wings
            const z = 0; // Center
            
            // Wireframe box for stairwell
            const geo = new THREE.BoxGeometry(4, C.podiumH, 6);
            const mesh = new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ color: 0xef4444, wireframe: true, transparent: true, opacity: 0.3 }));
            mesh.position.set(x, C.podiumH/2, z);
            groups.publicStair.add(mesh);

            // Zigzag line
            buildStaircase(x, z, 0, C.podiumH, groups.publicStair, true);
            
            addLabel("1-3F 共用梯", x + 5, C.podiumH/2, z);
        }

        // Helper: Draw Stair Zigzag
        function buildStaircase(x, z, yStart, h, group, isPublic) {
            const points = [];
            const steps = 8;
            const stepH = h / steps;
            const width = isPublic ? 3 : 2; // Public stair wider

            for(let i=0; i<=steps; i++) {
                // Zigzag in X axis (or Z axis)
                const offset = (i % 2 === 0) ? width/2 : -width/2;
                // If public (side), zig in Z. If private (tower), zig in X or Z inside tower.
                points.push(new THREE.Vector3(x + (isPublic ? 0 : offset), yStart + i*stepH, z + (isPublic ? offset : 0)));
            }
            const geo = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geo, isPublic ? matStairPublic : matStairPrivate);
            group.add(line);
        }

        // 3. External Elevators & Corridors
        // North (21/22) - Z Negative
        // South (23/24) - Z Positive
        function buildElevators() {
            // Calculate external position
            // Wings are at +/- (Gap/2 + WingD/2). 
            // Recess depth is Gap/2? No, wings stick out. Recess is the space between them?
            // "Butterfly" usually means wings stick out, core is recessed.
            // Or Wings are recessed? 
            // Let's assume Elevators are in the "Gap" between 21 and 22.
            
            const nZ = -(C.gap/2 + C.wingD) - 4; // 4m away from building face
            buildSingleSystem(0, nZ, "北梯", -1); // -1 direction (towards negative Z)

            const sZ = (C.gap/2 + C.wingD) + 4;
            buildSingleSystem(0, sZ, "南梯", 1);
        }

        function buildSingleSystem(x, z, name, dir) {
            const h = C.podiumH + C.towerH;
            
            // Shaft
            const shaft = new THREE.Mesh(new THREE.BoxGeometry(2.5, h, 2.5), matElevator);
            shaft.position.set(x, h/2, z);
            groups.elevator.add(shaft);
            
            // Frame
            const frame = new THREE.LineSegments(new THREE.WireframeGeometry(shaft.geometry), new THREE.LineBasicMaterial({ color: 0x60a5fa }));
            shaft.add(frame);
            
            addLabel(name, x, h + 2, z);

            // Corridors (3-9F)
            for(let f=3; f<=9; f++) {
                const y = C.podiumH + (f-3)*3 + 0.2;
                
                // Bridge from Shaft to Building Face
                // Building face is at +/- (Gap/2 + WingD).
                // Shaft is at +/- (Gap/2 + WingD + 4).
                // Distance = 4m.
                
                const bridgeLen = 4;
                const bridge = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, bridgeLen), matCorridor);
                
                // Center of bridge: z - (dir * bridgeLen/2)
                bridge.position.set(x, y, z - (dir * bridgeLen/2));
                groups.elevator.add(bridge);
                
                // Horizontal Connector at Building Face (T-Shape to enter wings)
                // Connects to 21/22 or 23/24 doors
                const spreadW = 8; // Spreads left and right to enter wings
                const spread = new THREE.Mesh(new THREE.BoxGeometry(spreadW, 0.2, 1.5), matCorridor);
                spread.position.set(x, y, z - (dir * bridgeLen)); // At building face
                groups.elevator.add(spread);
            }
        }

        // --- Init ---
        buildBuilding();
        buildPublicStair();
        buildElevators();

        scene.add(groups.building);
        scene.add(groups.publicStair);
        scene.add(groups.privateStair);
        scene.add(groups.elevator);

        // --- Helpers ---
        function addLabel(text, x, y, z) {
            const div = document.createElement('div');
            div.className = 'label-tag';
            div.textContent = text;
            const label = new CSS2DObject(div);
            label.position.set(x, y, z);
            scene.add(label);
        }

        window.toggleLayer = (name) => {
            groups[name].visible = !groups[name].visible;
        };

        window.toggleTransparency = () => {
            const isTransparent = document.getElementById('transparencyToggle').checked;
            matWall.opacity = isTransparent ? 0.3 : 0.9;
            matWall.needsUpdate = true;
        };
        
        // Start transparent for x-ray feel
        document.getElementById('transparencyToggle').click(); 

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }
        animate();
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
